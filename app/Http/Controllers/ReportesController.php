<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Database\QueryException;
use Yajra\Datatables\Datatables;
use Illuminate\Support\Facades\Auth;
use Exception;

class ReportesController extends Controller
{
    //
    public function getIndex()
    {
        return view('sistema.reportes.reportes'/*, compact('edos')*/);
    }

    public function getDataEmpresasAtendidas(Request $request)
    {
        $where = '';
        if(Auth::user()->rol == 5){
            $where  = "solicitudes.objeto = 'FINANCIAMIENTO' and ";
        }

        $encuestas = DB::select( DB::raw("select (select users.nombre from users where users.id = empresas.usuario and users.rol = 2 ) as atendido_por, empresas.empresa, empresas.rif, empresas.telf, empresas.sector, empresas.rubro, empresas.convenio, solicitudes.origen, solicitudes.ori_especifique, solicitudes.objeto, solicitudes.fin_montobs, solicitudes.fin_montousd, solicitudes.fin_para, solicitudes.fin_banco,( select concat(to_char(cast(acciones.fecha as date), 'DD/MM/YYYY'),' - REMITIDO A: ',acciones.remitido_a,', ',acciones.observacion) from acciones where acciones.id_sol = solicitudes.id and acciones.ra_nivel = (select max(acciones.ra_nivel) from acciones where acciones.id_sol = solicitudes.id )) ult_acc_reg, ( select concat(to_char(cast(seguimiento.fecha as date), 'DD/MM/YYYY'),' - ESTATUS: ',seguimiento.status,', ',seguimiento.descripcion) from seguimiento where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) ult_seg_reg,  to_char(solicitudes.fecha, 'DD/MM/YYYY')as fecha, solicitudes.observacion, solicitudes.status,to_char(solicitudes.fecha_status, 'DD/MM/YYYY') as fecha_status  from empresas,solicitudes where ".$where." empresas.rif = solicitudes.emp_rif and solicitudes.fecha BETWEEN '".$request->f_ini."' AND '".$request->f_fin."' and EXISTS (select users.nombre from users where users.id = empresas.usuario and users.rol = 2 )GROUP BY empresas.usuario, empresas.empresa, empresas.rif, empresas.telf, empresas.sector, empresas.rubro, empresas.convenio, solicitudes.objeto, solicitudes.id ORDER BY atendido_por, empresas.empresa, solicitudes.fecha   asc"));

        $datatble = Datatables::of($encuestas)
        ->editColumn('solicitudes.fin_montobs', function ($rep) {
            return number_format($rep->fin_montobs, 2, ',', '.');//str_replace('.',',',$rep->fin_montobs);
        })
        ->editColumn('solicitudes.fin_montousd', function ($rep) {
            return number_format($rep->fin_montousd, 2, ',', '.');//str_replace('.',',',$rep->fin_montobs);
        });
        return $datatble->make(true);

    }
//  and uu.rol = 2
    public function getDataStatusSolicitud(Request $request)
    {

        $encuestas = DB::select( DB::raw("select concat((select uu.nombre from users as uu where uu.id = u.id),' ','ZPROMEDIO') as atendido_por,
'' as empresa, '' as objeto, ( select avg(suma) from ( select (case when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) IS NULL then 0    when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN PROCESO' then 25 when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN REVISION' then 50 when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'APROBADO' then 75 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 ELSE 100 end) as suma from empresas,solicitudes  where  empresas.rif = solicitudes.emp_rif and  solicitudes.fecha BETWEEN  '".$request->f_ini."' AND '".$request->f_fin."' and empresas.usuario = u.id GROUP BY empresas.empresa, solicitudes.objeto, solicitudes.id, solicitudes.fecha )as suma  ) as promedio from users as u where u.rol = 2 GROUP BY u.id HAVING ( select avg(suma) from (select (case when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) IS NULL then 0 when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN PROCESO' then 25 when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN REVISION' then 50 when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'APROBADO' then 75 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 ELSE 100 end) as suma from empresas,solicitudes  where empresas.rif = solicitudes.emp_rif and solicitudes.fecha BETWEEN '".$request->f_ini."' AND '".$request->f_fin."' and empresas.usuario = u.id GROUP BY empresas.empresa, solicitudes.objeto, solicitudes.id, solicitudes.fecha )as suma ) IS NOT NULL union all select (select uu.nombre from users as uu where uu.id = empresas.usuario) as atendido_por, empresas.empresa , solicitudes.objeto,  (case when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) IS NULL then 0 when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN PROCESO' then 25 when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN REVISION' then 50 when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'APROBADO' then 75 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 ELSE 100 end) as promedio from empresas,solicitudes where empresas.rif = solicitudes.emp_rif  and  solicitudes.fecha BETWEEN '".$request->f_ini."' AND '".$request->f_fin."' and EXISTS (select uu.nombre from users as uu where uu.id = empresas.usuario  and uu.rol = 2) GROUP BY empresas.empresa, empresas.usuario, solicitudes.objeto, solicitudes.id, solicitudes.fecha order by atendido_por asc "));

        $datatble = Datatables::of($encuestas)
            /*->editColumn('solicitudes.fin_montobs', function ($rep) {
                return number_format($rep->fin_montobs, 2, ',', '.');//str_replace('.',',',$rep->fin_montobs);
            })*/
            ->editColumn('promedio', function ($rep) {
                return round($rep->promedio, 2);//str_replace('.',',',$rep->fin_montobs);
            });
        return $datatble->make(true);

    }
}


/*
 *
select (case when (SELECT users.nombre FROM users, logs as l where users.user = l.usuario and l.modulo = 'EMPRESA' and l.accion like 'AGREGAR%' and l.empresa = logs.empresa) <> NULL then (SELECT users.nombre FROM users, logs as l where users.user = l.usuario and l.modulo = 'EMPRESA' and l.accion like 'AGREGAR%' and l.empresa = logs.empresa) else (select users.nombre from logs as l, solicitudes as s, users where l.usuario = users.user and l.empresa = s.emp_rif and l.modulo = 'SOLICITUD' and l.accion ilike 'AGREGAR%' and s.id = (select min(ss.id) from solicitudes as ss where ss.emp_rif = logs.empresa ) and l.empresa = logs.empresa ORDER BY s.id asc limit 1 offset 0) end) as atendido_por,(select empresas.empresa from empresas where empresas.rif = logs.empresa) as empresa, (select empresas.telf from empresas where empresas.rif = logs.empresa) as telf, (select empresas.sector from empresas where empresas.rif = logs.empresa) as sector, (select empresas.rubro from empresas where empresas.rif = logs.empresa) as rubro, (select empresas.convenio from empresas where empresas.rif = logs.empresa) as convenio,solicitudes.origen, solicitudes.ori_especifique, solicitudes.objeto, solicitudes.fin_montobs, solicitudes.fin_montousd, solicitudes.fin_para,solicitudes.fin_banco,( select concat(to_char(cast(acciones.fecha as date), 'DD/MM/YYYY'),' - REMITIDO A: ',acciones.remitido_a,', ',acciones.observacion) from acciones where acciones.id_sol = solicitudes.id and acciones.ra_nivel = (select max(acciones.ra_nivel) from acciones where acciones.id_sol = solicitudes.id )) ult_acc_reg, ( select concat(to_char(cast(seguimiento.fecha as date), 'DD/MM/YYYY'),' - ESTATUS: ',seguimiento.status,', ',seguimiento.descripcion) from seguimiento where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) ult_seg_reg,  to_char(solicitudes.fecha, 'DD/MM/YYYY')as fecha, solicitudes.observacion from logs,solicitudes where logs.empresa = solicitudes.emp_rif and logs.modulo = 'SOLICITUD' and logs.accion ilike '%AGREGAR%' and solicitudes.fecha BETWEEN '".$request->f_ini."' AND '".$request->f_fin."' GROUP BY logs.empresa, solicitudes.objeto, solicitudes.id ORDER BY solicitudes.fecha, atendido_por, empresa asc


select concat((select uu.nombre from users as uu where uu.user = u.user),' ','ZPROMEDIO') as atendido_por,'' as empresa, '' as objeto, ( select avg(suma) from ( select (case when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) IS NULL then 0  when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN PROCESO' then 25 when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN REVISION' then 50 when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'APROBADO' then 75 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 ELSE 100 end) as suma from logs,solicitudes  where  logs.empresa = solicitudes.emp_rif and  logs.modulo = 'SOLICITUD' and logs.accion ilike '%AGREGAR%' and solicitudes.fecha BETWEEN  '".$request->f_ini."' AND '".$request->f_fin."' and logs.usuario = u.user GROUP BY logs.empresa, solicitudes.objeto, solicitudes.id, solicitudes.fecha )as suma  ) as promedio from users as u where u.rol = 2 GROUP BY u.user HAVING ( select avg(suma) from (select (case when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) IS NULL then 0 when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN PROCESO' then 25 when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN REVISION' then 50 when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'APROBADO' then 75 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 ELSE 100 end) as suma from logs,solicitudes  where logs.empresa = solicitudes.emp_rif and logs.modulo = 'SOLICITUD' and logs.accion ilike '%AGREGAR%' and solicitudes.fecha BETWEEN '".$request->f_ini."' AND '".$request->f_fin."' and logs.usuario = u.user
GROUP BY logs.empresa, solicitudes.objeto, solicitudes.id, solicitudes.fecha )as suma ) IS NOT NULL union all select (case when (SELECT users.nombre FROM users, logs as l where users.user = l.usuario and l.modulo = 'EMPRESA' and l.accion like 'AGREGAR%' and l.empresa = logs.empresa) <> NULL then (SELECT users.nombre FROM users, logs as l where users.user = l.usuario and l.modulo = 'EMPRESA' and l.accion like 'AGREGAR%' and l.empresa = logs.empresa) else (select users.nombre from logs as l, solicitudes as s, users where l.usuario = users.user and l.empresa = s.emp_rif and l.modulo = 'SOLICITUD' and l.accion ilike 'AGREGAR%' and s.id = (select min(ss.id) from solicitudes as ss where ss.emp_rif = logs.empresa ) and l.empresa = logs.empresa ORDER BY s.id asc limit 1 offset 0) end) as atendido_por,(select empresas.empresa from empresas where empresas.rif = logs.empresa) as empresa, solicitudes.objeto, (case when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) IS NULL then 0 when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN PROCESO' then 25 when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN REVISION' then 50 when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'APROBADO' then 75 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 ELSE 100 end) as promedio from logs,solicitudes where logs.empresa = solicitudes.emp_rif and logs.modulo = 'SOLICITUD' and logs.accion ilike '%AGREGAR%' and  solicitudes.fecha BETWEEN '".$request->f_ini."' AND '".$request->f_fin."' GROUP BY logs.empresa, solicitudes.objeto, solicitudes.id, solicitudes.fecha order by atendido_por asc


-------------------------------------------------------------------------------------
select (case when (SELECT users.nombre FROM users, logs as l where users.user = l.usuario and l.modulo = 'EMPRESA' and l.accion like 'AGREGAR%' and l.empresa = logs.empresa) <> NULL then (SELECT users.nombre FROM users, logs as l where users.user = l.usuario and l.modulo = 'EMPRESA' and l.accion like 'AGREGAR%' and l.empresa = logs.empresa) else (select users.nombre from logs as l, solicitudes as s, users where l.usuario = users.user and l.empresa = s.emp_rif and l.modulo = 'SOLICITUD' and l.accion ilike 'AGREGAR%' and s.id = (select min(ss.id) from solicitudes as ss where ss.emp_rif = logs.empresa ) and l.empresa = logs.empresa ORDER BY s.id asc limit 1 offset 0) end) as atendido_por, (select empresas.empresa from empresas where empresas.rif = logs.empresa) as empresa, solicitudes.objeto, (case when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) IS NULL then 0 when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN PROCESO' then 25 when ( select seguimiento.status from seguimiento  where seguimiento.id_sol = solicitudes.id  and  seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'EN REVISION' then 50 when ( select seguimiento.status from seguimiento where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'APROBADO' then 75 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 when ( select seguimiento.status  from seguimiento  where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) = 'CULMINADO' then 100 ELSE 100 end) as p_avance from logs,solicitudes where logs.empresa = solicitudes.emp_rif and logs.modulo = 'SOLICITUD' and logs.accion ilike '%AGREGAR%' and solicitudes.fecha BETWEEN '".$request->f_ini."' AND '".$request->f_fin."' GROUP BY logs.empresa, solicitudes.objeto, solicitudes.id, solicitudes.fecha ORDER BY atendido_por, empresa, solicitudes.fecha asc

select (select users.nombre from users where users.user = logs.usuario) as atendido_por,
(select empresas.empresa from empresas where empresas.rif = logs.empresa) as empresa, solicitudes.objeto, solicitudes.fin_montobs, solicitudes.fin_montousd, ( select concat(to_char(cast(acciones.fecha as date), 'DD/MM/YYYY'),' - REMITIDO A: ',acciones.remitido_a,', ',acciones.observacion) from acciones where acciones.id_sol = solicitudes.id and acciones.ra_nivel = (select max(acciones.ra_nivel) from acciones where acciones.id_sol = solicitudes.id )) ult_acc_reg,( select concat(to_char(cast(seguimiento.fecha as date), 'DD/MM/YYYY'),' - ESTATUS: ',seguimiento.status,', ',seguimiento.descripcion) from seguimiento where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) ult_seg_reg, to_char(cast(logs.fecha as date), 'DD/MM/YYYY')as fecha, solicitudes.observacion from logs,solicitudes where logs.empresa = solicitudes.emp_rif and logs.modulo = 'SOLICITUD' and logs.accion ilike 'AGREGAR%' and cast(logs.fecha as date) BETWEEN '".$request->f_ini."' AND '".$request->f_fin."' GROUP BY logs.empresa,logs.usuario, solicitudes.objeto, solicitudes.id, cast(logs.fecha as date) ORDER BY solicitudes.fecha, atendido_por, empresa asc


select (select users.nombre from users where users.user = logs.usuario) as atendido_por, (select empresas.empresa from empresas where empresas.rif = logs.empresa) as empresa, solicitudes.origen, solicitudes.ori_especifique, solicitudes.objeto, solicitudes.fin_montobs, solicitudes.fin_montousd, ( select concat(to_char(cast(acciones.fecha as date), 'DD/MM/YYYY'),' - REMITIDO A: ',acciones.remitido_a,', ',acciones.observacion) from acciones where acciones.id_sol = solicitudes.id and acciones.ra_nivel = (select max(acciones.ra_nivel) from acciones where acciones.id_sol = solicitudes.id )) ult_acc_reg,( select concat(to_char(cast(seguimiento.fecha as date), 'DD/MM/YYYY'),' - ESTATUS: ',seguimiento.status,', ',seguimiento.descripcion) from seguimiento where seguimiento.id_sol = solicitudes.id  and seguimiento.id = (select max(seguimiento.id) from seguimiento where seguimiento.id_sol = solicitudes.id )) ult_seg_reg, to_char(solicitudes.fecha, 'DD/MM/YYYY')as fecha, solicitudes.observacion from logs,solicitudes where logs.empresa = solicitudes.emp_rif and logs.modulo = 'SOLICITUD' and logs.accion ilike '%AGREGAR%' and solicitudes.fecha BETWEEN '".$request->f_ini."' AND '".$request->f_fin."' GROUP BY logs.empresa,logs.usuario, solicitudes.objeto, solicitudes.id ORDER BY solicitudes.fecha, atendido_por, empresa asc



*/
